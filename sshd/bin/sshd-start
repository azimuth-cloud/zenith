#!/usr/bin/env bash

set -e

# Decide what address to use for Consul
# If not explicitly given, we use HOST_IP:8500
# This will work in Kubernetes with Consul deployed using the official Helm chart
# and HOST_IP configured via the downward API
if [ -z "$CONSUL_HTTP_ADDR" ]; then
    if [ -n "$HOST_IP" ]; then
        CONSUL_HTTP_ADDR="${HOST_IP}:8500"
    else
        echo "CONSUL_HTTP_ADDR or HOST_IP must be set" 1>&2
        exit 1
    fi
fi
SET_ENV="CONSUL_HTTP_ADDR=\"${CONSUL_HTTP_ADDR}\""

# The service host can be explicitly specified, but the default of "hostname -i"
# will be sufficient in almost all cases
if [ -z "$SERVICE_HOST" ]; then
    SERVICE_HOST="$(hostname -i)"
fi
SET_ENV="$SET_ENV SERVICE_HOST=\"${SERVICE_HOST}\""

# The following variables are optional with defaults defined in the tunnel-init script
# Negotiaiting configuration with a well-behaved client should be fast
if [ -n "$CONFIGURE_TIMEOUT" ]; then
    SET_ENV="$SET_ENV CONFIGURE_TIMEOUT=\"${CONFIGURE_TIMEOUT}\""
fi
if [ -n "$CONSUL_TTL" ]; then
    SET_ENV="$SET_ENV CONSUL_TTL=\"${CONSUL_TTL}\""
fi
if [ -n "$CONSUL_HEARTBEAT_INTERVAL" ]; then
    SET_ENV="$SET_ENV CONSUL_HEARTBEAT_INTERVAL=\"${CONSUL_HEARTBEAT_INTERVAL}\""
fi
if [ -n "$CONSUL_DEREGISTER_INTERVAL" ]; then
    SET_ENV="$SET_ENV CONSUL_DEREGISTER_INTERVAL=\"${CONSUL_DEREGISTER_INTERVAL}\""
fi
if [ -n "$CONSUL_HEARTBEAT_FAILURES" ]; then
    SET_ENV="$SET_ENV CONFIGURE_TIMEOUT=\"${CONSUL_HEARTBEAT_FAILURES}\""
fi

# Make sure /var/run/sshd exists and is not group or world-writable
mkdir -p /var/run/sshd
chmod g-w,o-w /var/run/sshd

# Generate unique hostkeys in /var/run/sshd if not present
if [ ! -r /var/run/sshd/ssh_host_dsa_key ]; then
    ssh-keygen -q -N "" -t dsa -f /var/run/sshd/ssh_host_dsa_key
fi
if [ ! -r /var/run/sshd/ssh_host_rsa_key ]; then
    ssh-keygen -q -N "" -t rsa -b 4096 -f /var/run/sshd/ssh_host_rsa_key
fi
if [ ! -r /var/run/sshd/ssh_host_ecdsa_key ]; then
    ssh-keygen -q -N "" -t ecdsa -b 521 -f /var/run/sshd/ssh_host_ecdsa_key
fi
if [ ! -r /var/run/sshd/ssh_host_ed25519_key ]; then
    ssh-keygen -q -N "" -t ed25519 -f /var/run/sshd/ssh_host_ed25519_key
fi

# Forward the required environment variables to SSH sessions so that the tunnel-init
# script can access them
exec /usr/sbin/sshd -D -e -o "SetEnv=$SET_ENV"
